<?phprequire_once("./inc/connect_db.php");// this file returns an xml file that confirms that the email address is updated and they agreement number the borrower has signed$y = true;$do_email = false;$agreement_id = addslashes($agreement_id);$student_id = addslashes($student_id);$other_email = addslashes($other_email);if ($y) {	// do return data	require_once './Classes/PHPExcel.php';			// Create new PHPExcel object	$objPHPExcel = new PHPExcel();		// Set properties	$objPHPExcel->getProperties()->setCreator("SOAR Multimedia Inc.")								 ->setLastModifiedBy("Ray Gubala")								 ->setTitle("Inventory Export")								 ->setSubject("Inventory Export")								 ->setDescription("Inventory Export")								 ->setKeywords("Inventory Export")								 ->setCategory("Inventory Export");		$line = 1;		$start_day = date("l h:i:s a, F d Y");		$objPHPExcel->setActiveSheetIndex(0)		->setCellValue("A$line", "$start_day");	$styleArray = array('font' => array('bold' => true));	$styleSmallArray = array('font' => array('size' => 8));	$objPHPExcel->getActiveSheet()->getStyle("A$line")->applyFromArray($styleArray);  		  	++$line;  	  	++$line;	$objPHPExcel->setActiveSheetIndex(0)		->setCellValue("A$line", "Description")		->setCellValue("B$line", "Category")		->setCellValue("C$line", "Notes")		->setCellValue("D$line", "Asset Count")		->setCellValue("E$line", "Lost")		->setCellValue("F$line", "Repair")		->setCellValue("G$line", "Retired")		->setCellValue("H$line", "Do Not Display")		->setCellValue("I$line", "Active")		->setCellValue("J$line", "Reserved")		->setCellValue("K$line", "Signed Out")		->setCellValue("L$line", "Available")		->setCellValue("M$line", "Scanned for Inventory");						  	++$line;							$query = "SELECT asset_description, notes	FROM assets	GROUP BY asset_description	ORDER BY asset_description ";	$mysql_result = mysql_query($query, $mysql_link);	while($row = mysql_fetch_row($mysql_result)) {		$assets_asset_description = stripslashes($row[0]);		$assets_notes = htmlspecialchars(stripslashes($row[1]));				$assets_asset_description2 = addslashes($assets_asset_description);		$assets_count = 0;				// Get total amount of this product		$query2 = "SELECT COUNT(id)		FROM assets		WHERE asset_description = '$assets_asset_description2' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_count = stripslashes($row2[0]);		}										// Get total amount of this product by active		$query2 = "SELECT COUNT(id)		FROM assets		WHERE asset_description = '$assets_asset_description2' 		AND actions_id  = '1' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$active = stripslashes($row2[0]);		}				// Get total amount of this product by lost		$query2 = "SELECT COUNT(id)		FROM assets		WHERE asset_description = '$assets_asset_description2' 		AND actions_id  = '2' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$lost = stripslashes($row2[0]);		}				// Get total amount of this product by repair		$query2 = "SELECT COUNT(id)		FROM assets		WHERE asset_description = '$assets_asset_description2' 		AND actions_id  = '3' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$repair = stripslashes($row2[0]);		}				// Get total amount of this product by retired		$query2 = "SELECT COUNT(id)		FROM assets		WHERE asset_description = '$assets_asset_description2' 		AND actions_id  = '4' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$retired = stripslashes($row2[0]);		}				// Get total amount of this product by donotdisplay		$query2 = "SELECT COUNT(id)		FROM assets		WHERE asset_description = '$assets_asset_description2' 		AND actions_id  = '5' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$donotdisplay = stripslashes($row2[0]);		}																// Get total temporarily booked by students (prior to offical check out by staff)		$query2 = "SELECT COUNT(assets_description)		FROM assets_bin		WHERE assets_description = '$assets_asset_description2' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_bin_count = stripslashes($row2[0]);		}				// Get total in reserve for this product		$assets_reserve = 0;				$query2 = "SELECT reserve		FROM assets_reserve		WHERE asset_description = '$assets_asset_description2' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_reserve = stripslashes($row2[0]);		}				// Get how many have been already signed out for this product		//unset($assets_list);		$signed_out = 0;				$query2 = "SELECT id		FROM assets		WHERE asset_description = '$assets_asset_description2' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_id = stripslashes($row2[0]);						//$x = 0;						$query3 = "SELECT count(assets_id)			FROM assets_logged_out			WHERE in_time = '0'			AND assets_id = '$assets_id' ";			$mysql_result3 = mysql_query($query3, $mysql_link);			while($row3 = mysql_fetch_row($mysql_result3)) {				if ($row3[0] > 0)				{			        $signed_out++;				}			}			/*if ($x == 1) {				//$assets_list[$assets_id] = $assets_id;				++$signed_out;			} */		}				// Derive total available from above numbers		$assets_count_available = $active - $assets_reserve - $signed_out;		if ($assets_count_available < 0) {			$assets_count_available = 0;		}				$assets_asset_description2 = addslashes($assets_asset_description);				$query2 = "SELECT categories_id		FROM assets		WHERE asset_description = '$assets_asset_description2'		AND categories_id != '0' ";		//print("$query2<br /.");		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_categories_id = addslashes($row2[0]);;		}				$query2 = "SELECT name		FROM categories		WHERE id = '$assets_categories_id' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$categories_name = addslashes($row2[0]);;		}				unset($scan_count);		$query2 = "SELECT inventory.scan_date		FROM assets, inventory		WHERE assets.id = inventory.assets_id		AND assets.asset_description = '$assets_asset_description2' 		GROUP BY assets.id ";		//print("$query2<br />");		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			++$scan_count;		}			  	++$line;		$objPHPExcel->setActiveSheetIndex(0)			->setCellValue("A$line", "$assets_asset_description")			->setCellValue("B$line", "$categories_name")			->setCellValue("C$line", "$assets_notes")			->setCellValue("D$line", "$assets_count")			->setCellValue("E$line", "$lost")			->setCellValue("F$line", "$repair")			->setCellValue("G$line", "$retired")			->setCellValue("H$line", "$donotdisplay")			->setCellValue("I$line", "$active")			->setCellValue("J$line", "$assets_reserve")			->setCellValue("K$line", "$signed_out")			->setCellValue("L$line", "$assets_count_available")			->setCellValue("M$line", "$scan_count");			}		++$line;	++$line;	++$line;	++$line;	++$line;			$query = "SELECT asset_description, notes	FROM assets	GROUP BY asset_description	ORDER BY asset_description ";	$mysql_result = mysql_query($query, $mysql_link);	while($row = mysql_fetch_row($mysql_result)) {		$assets_asset_description = stripslashes($row[0]);		$assets_notes = htmlspecialchars(stripslashes($row[1]));				$assets_asset_description2 = addslashes($assets_asset_description);				++$line;		++$line;			$objPHPExcel->setActiveSheetIndex(0)				->setCellValue("A$line", "$assets_asset_description");		$objPHPExcel->getActiveSheet()->getStyle("A$line")->applyFromArray($styleArray);						++$line;			$objPHPExcel->setActiveSheetIndex(0)				->setCellValue("A$line", "Barcode")				->setCellValue("B$line", "Serial Number")				->setCellValue("C$line", "Category")				->setCellValue("D$line", "Action")				->setCellValue("E$line", "Notes")				->setCellValue("F$line", "Info")				->setCellValue("G$line", "Signed Out")				->setCellValue("H$line", "Borrower")				->setCellValue("I$line", "Scanned Date");						$query3 = "SELECT id, serial_number, durham_college_number, notes, actions_id, barcode, categories_id info		FROM assets		WHERE asset_description = '$assets_asset_description2' 		ORDER BY actions_id ";		//print("$query");		$mysql_result3 = mysql_query($query3, $mysql_link);		while($row3 = mysql_fetch_row($mysql_result3)) {			$id = stripslashes($row3[0]);			$serial_number = htmlspecialchars(stripslashes($row3[1]));			$durham_college_number = htmlspecialchars(stripslashes($row3[2]));			$notes = htmlspecialchars(stripslashes($row3[3]));			$action_id = htmlspecialchars(stripslashes($row3[4]));			$barcode = htmlspecialchars(stripslashes($row3[5]));			$categories_id = htmlspecialchars(stripslashes($row3[6]));			$info = htmlspecialchars(stripslashes($row3[7]));						$action_name = $action[$action_id];			$categories_name = $categories[$categories_id];				unset($student_id, $last_name, $first_name, $signed_out, $borrower, $scan_date);						$query2 = "SELECT borrowers.student_id, borrowers.last_name, borrowers.first_name, assets_logged_out.out_time			FROM assets_logged_out, borrowers			WHERE assets_logged_out.borrowers_id = borrowers.id			AND assets_logged_out.assets_id = '$id'			AND assets_logged_out.in_time = '0' ";			//print("$query2<br />");			$mysql_result2 = mysql_query($query2, $mysql_link);			while($row2 = mysql_fetch_row($mysql_result2)) {				$student_id = stripslashes($row2[0]);				$last_name = stripslashes($row2[1]);				$first_name = stripslashes($row2[2]);				$signed_out = date("d M Y h:m A",$row2[3]);				$borrower = "$student_id $first_name $last_name";			}					$query2 = "SELECT inventory.scan_date			FROM assets, inventory			WHERE assets.id = inventory.assets_id			AND assets.id = '$id'";			//print("$query2<br />");			$mysql_result2 = mysql_query($query2, $mysql_link);			while($row2 = mysql_fetch_row($mysql_result2)) {				$scan_date = date("d M Y h:m A",$row2[0]);			}									++$line;			$objPHPExcel->setActiveSheetIndex(0)				->setCellValue("A$line", "$barcode")				->setCellValue("B$line", "$serial_number")				->setCellValue("C$line", "$categories_name")				->setCellValue("D$line", "$action_name")				->setCellValue("E$line", "$notes")				->setCellValue("F$line", "$info")				->setCellValue("G$line", "$signed_out")				->setCellValue("H$line", "$borrower")				->setCellValue("I$line", "$scan_date");				/*			print("<asset>			<asset_description>$assets_asset_description</asset_description>			<assets_id>$assets_id</assets_id>			<serial_number>$serial_number</serial_number>			<durham_college_number>$durham_college_number</durham_college_number>			<notes>$notes</notes>			<action_id>$action_id</action_id>			<action_name>$action_name</action_name>			<barcode>$barcode</barcode>			<categories_id>$categories_id</categories_id>			<categories_name>$categories_name</categories_name>			<info>$info</info>			<signed_out>$signed_out</signed_out>			<borrower>$borrower</borrower>			<inventory>$scan_date</inventory>			</asset>			");			*/				}						}					$objPHPExcel->getActiveSheet()->setTitle('Inventory Report $start_day');			// Set active sheet index to the first sheet, so Excel opens this as the first sheet	$objPHPExcel->setActiveSheetIndex(0);			// Redirect output to a clientÕs web browser (Excel2007)		header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');	header('Content-Disposition: attachment;filename="inventory_report.php"');	header('Cache-Control: max-age=0');		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');	$objWriter->save('php://output');	exit;	} else {	}?>