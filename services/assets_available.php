<?phprequire_once("./inc/connect_db.php");// this file returns an xml file that confirms that the email address is updated and they agreement number the borrower has signed$y = true;$do_email = false;$agreement_id = addslashes($agreement_id);$student_id = addslashes($student_id);$other_email = addslashes($other_email);$replacement_cost = addslashes($replacement_cost);if ($description) {	$description = addslashes($description);	$reserve = addslashes($reserve);	$categories_id = addslashes($categories_id);	$notes = addslashes($notes);	$query = "UPDATE assets	SET asset_description = '$description',	notes = '$notes', 	categories_id = '$categories_id'	WHERE asset_description = '$org_description' ";	$mysql_result = mysql_query($query, $mysql_link);		$query2 = "SELECT id	FROM assets_reserve	WHERE asset_description = '$org_description' ";	$mysql_result2 = mysql_query($query2, $mysql_link);	while($row2 = mysql_fetch_row($mysql_result2)) {		$assets_reserve_id = stripslashes($row2[0]);	}	if ($assets_reserve_id) {		// update		$query2 = "UPDATE assets_reserve		SET asset_description = '$description',		reserve = '$reserve', 		replacement_cost = '$replacement_cost'		WHERE id = '$assets_reserve_id' ";		$mysql_result2 = mysql_query($query2, $mysql_link);	} else {		// insert		$query2 = "INSERT INTO assets_reserve		SET asset_description = '$description',		reserve = '$reserve', 		replacement_cost = '$replacement_cost' ";		$mysql_result2 = mysql_query($query2, $mysql_link);	}			}if ($y) {	header("Content-type: text/xml");		print("<?xml version=\"1.0\" encoding=\"iso-8859-1\"?>	<data>	");		$query = "SELECT asset_description, notes	FROM assets	WHERE actions_id = '1'	GROUP BY asset_description	ORDER BY asset_description ";	$mysql_result = mysql_query($query, $mysql_link);	while($row = mysql_fetch_row($mysql_result)) {		$assets_asset_description = stripslashes($row[0]);		$assets_notes = htmlspecialchars(stripslashes($row[1]));				$assets_asset_description2 = addslashes($assets_asset_description);		$assets_count = 0;				// Get total amount of this product		$query2 = "SELECT COUNT(id)		FROM assets		WHERE asset_description = '$assets_asset_description2' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_count = stripslashes($row2[0]);		}				// Get total amount of this product		$query2 = "SELECT COUNT(id)		FROM assets		WHERE asset_description = '$assets_asset_description2' 		AND actions_id = '1' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_count_active = stripslashes($row2[0]);		}						// Get total temporarily booked by students (prior to offical check out by staff)		$query2 = "SELECT COUNT(assets_description)		FROM assets_bin		WHERE assets_description = '$assets_asset_description2' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_bin_count = stripslashes($row2[0]);		}										// Get total in reserve for this product		$assets_reserve = 0;				unset($assets_reserve, $assets_reserve_replacement_cost);				$query2 = "SELECT reserve, replacement_cost		FROM assets_reserve		WHERE asset_description = '$assets_asset_description2' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_reserve = stripslashes($row2[0]);			$assets_reserve_replacement_cost = stripslashes($row2[1]);		}				// Get how many have been already signed out for this product		//unset($assets_list);		$signed_out = 0;				$query2 = "SELECT id		FROM assets		WHERE asset_description = '$assets_asset_description2' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_id = stripslashes($row2[0]);						//$x = 0;						$query3 = "SELECT count(assets_id)			FROM assets_logged_out			WHERE in_time = '0'			AND assets_id = '$assets_id' ";			$mysql_result3 = mysql_query($query3, $mysql_link);			while($row3 = mysql_fetch_row($mysql_result3)) {				if ($row3[0] > 0)				{			        $signed_out++;				}			}			/*if ($x == 1) {				//$assets_list[$assets_id] = $assets_id;				++$signed_out;			} */		}				// Derive total available from above numbers		$signed_out = $signed_out + $assets_bin_count;				$assets_count_available = $assets_count_active - $assets_reserve - $signed_out;		if ($assets_count_available < 0) {			$assets_count_available = 0;		}				$assets_asset_description2 = addslashes($assets_asset_description);				$query2 = "SELECT categories_id		FROM assets		WHERE asset_description = '$assets_asset_description2'		AND categories_id != '0' ";		//print("$query2<br /.");		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$assets_categories_id = addslashes($row2[0]);;		}				$query2 = "SELECT name		FROM categories		WHERE id = '$assets_categories_id' ";		$mysql_result2 = mysql_query($query2, $mysql_link);		while($row2 = mysql_fetch_row($mysql_result2)) {			$categories_name = addslashes($row2[0]);;		}								print("<asset_types>		<asset_description>$assets_asset_description</asset_description>		<assets_count>$assets_count</assets_count>		<assets_reserve>$assets_reserve</assets_reserve>		<assets_bin>$assets_count_active</assets_bin>		<signed_out>$signed_out</signed_out>		<assets_count_available>$assets_count_available</assets_count_available>		<image>$image</image>		<categories_id>$assets_categories_id</categories_id>		<categories_name>$categories_name</categories_name>		<notes>$assets_notes</notes>		<replacement_cost>$assets_reserve_replacement_cost</replacement_cost>		</asset_types>		");			}	print("</data>	");	} else {	// send no access allowed	header("Content-type: text/xml");	print("<?xml version=\"1.0\" encoding=\"iso-8859-1\"?>	<data>		<student_id>$student_id</student_id>		<error>Update Failed!</error>	</data>	");}$dbh = null;?>